name: PM Notification (Linear)

on:
  push:
    branches:
      - main
      - develop
      - staging

jobs:
  notify-pm:
    name: Notify PM of Deployment (Linear)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build action
        run: npm run package

      - name: Run Eng <> PM Mediator with Linear
        uses: ./
        with:
          issue_tracker: linear
          linear_api_key: ${{ secrets.LINEAR_API_KEY }}
          linear_team_key: ${{ secrets.LINEAR_TEAM_KEY }}
          slack_bot_token: ${{ secrets.SLACK_BOT_TOKEN }}
          slack_channel_or_user: ${{ secrets.SLACK_PM_CHANNEL }}
          environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          # Optional: filter to only active cycle
          only_active_sprint: 'false'
          # Optional: filter by specific statuses
          # ticket_status_filter: 'In Progress,In Review,Ready for Testing'
          # Optional: provide PM mapping
          # pm_mapping_json: '{"TEAM": "U01234567", "ENG": "U76543210"}'

      - name: Log results
        if: always()
        run: |
          echo "Issues found: ${{ steps.notify-pm.outputs.tickets_found }}"
          echo "Issues notified: ${{ steps.notify-pm.outputs.tickets_notified }}"
          echo "Message timestamp: ${{ steps.notify-pm.outputs.slack_message_ts }}"